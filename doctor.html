<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الطبيب | المزامنة الفورية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #45b39d; --dark: #16a085; --light: #f4fbf9;
            --white: #ffffff; --accent: #f39c12; --danger: #e74c3c;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; padding-bottom: 90px; }
        
        /* الهيدر */
        .doctor-nav {
            background: var(--white); padding: 15px 20px; display: flex;
            justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); sticky; top: 0; z-index: 1000;
        }

        /* قائمة الانتظار */
        .q-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .q-container { background: white; width: 90%; max-width: 450px; border-radius: 20px; overflow: hidden; }
        .q-header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .q-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.3s; }
        .q-item:hover { background: var(--light); border-right: 5px solid var(--primary); }

        /* منطقة العمل */
        .work-area { padding: 15px; display: none; }
        .patient-info-card { background: white; padding: 20px; border-radius: 15px; border-right: 5px solid var(--accent); margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .input-group { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        label { display: block; margin-bottom: 10px; font-weight: bold; color: var(--dark); }
        textarea { width: 100%; border: 1px solid #ddd; border-radius: 10px; padding: 12px; font-size: 16px; box-sizing: border-box; resize: none; outline: none; }
        textarea:focus { border-color: var(--primary); }

        /* الفوتر */
        .footer-bar { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px 20px; display: none; grid-template-columns: 1fr 2fr; gap: 10px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); box-sizing: border-box; }
        
        .btn { border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main { background: var(--primary); color: white; padding: 15px; }
        .btn-cancel { background: #fdedec; color: var(--danger); }
        
        .empty-state { text-align: center; padding: 100px 20px; color: #7f8c8d; }
    </style>
</head>
<body>

<nav class="doctor-nav">
    <div>
        <h3 style="margin:0; color:var(--dark)"><i class="fas fa-user-md"></i> لوحة الطبيب</h3>
        <small id="doc-name-display" style="color:var(--primary); font-weight:bold;">جاري التحميل...</small>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:var(--primary); color:white; padding:8px 15px;" onclick="openQueue()">
            <i class="fas fa-users"></i> الانتظار (<span id="q-count">0</span>)
        </button>
        <button class="btn" style="background:#fdedec; color:var(--danger); width:40px; height:40px; border-radius:50%;" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
</nav>

<div id="welcome-screen" class="empty-state">
    <i class="fas fa-clinic-medical fa-5x" style="color:#ddd; margin-bottom:20px;"></i>
    <h2>أهلاً بك دكتور</h2>
    <p>برجاء اختيار مريض من قائمة الانتظار للبدء</p>
    <button class="btn btn-main" style="margin:20px auto; padding:10px 30px;" onclick="openQueue()">فتح قائمة الانتظار</button>
</div>

<div id="work-area" class="work-area">
    <div class="patient-info-card">
        <small>المريض الحالي:</small>
        <h2 id="active-p-name" style="margin:5px 0 0 0;">---</h2>
        <small id="active-p-phone" style="color:var(--gray)"></small>
    </div>

    <div class="input-group">
        <label><i class="fas fa-diagnoses"></i> التشخيص السريري</label>
        <textarea id="symptoms" rows="3" placeholder="سجل ملاحظاتك هنا..."></textarea>
    </div>

    <div class="input-group">
        <label><i class="fas fa-pills"></i> الروشتة العلاجية</label>
        <textarea id="prescription" rows="6" placeholder="اكتب العلاج والجرعات..."></textarea>
    </div>
</div>

<div id="footer-bar" class="footer-bar">
    <button class="btn btn-cancel" onclick="resetPage()">إلغاء</button>
    <button class="btn btn-main" onclick="savePrescription()">إنهاء وإرسال للصيدلية</button>
</div>

<div id="queue-modal" class="q-modal">
    <div class="q-container">
        <div class="q-header">
            <h3 style="margin:0">قائمة المرضى (بالخارج)</h3>
        </div>
        <div id="q-list" style="max-height:400px; overflow-y:auto;"></div>
        <button onclick="closeQueue()" style="width:100%; padding:15px; border:none; background:#eee; cursor:pointer;">إغلاق</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBy8xPvxQuC6bVLerLpSjzPmvBWyAhuYKo",
        authDomain: "mogama-49e7f.firebaseapp.com",
        projectId: "mogama-49e7f",
        storageBucket: "mogama-49e7f.firebasestorage.app",
        messagingSenderId: "575066177594",
        appId: "1:575066177594:web:82137834158b4c353db503"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // التحقق من اسم الدكتور وتنظيفه
    const doctorName = (localStorage.getItem('doctorName') || "").trim();
    if(!doctorName) window.location.href = "index.html";
    document.getElementById('doc-name-display').innerText = `د. ${doctorName}`;

    let currentPatient = null;

    // الحصول على تاريخ اليوم بنفس تنسيق صفحة الاستقبال
    const getTodayDate = () => {
        const d = new Date();
        return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
    };

    // --- الاستماع اللحظي لقائمة الانتظار ---
    const q = query(
        collection(db, "appointments"),
        where("doctor", "==", doctorName),
        where("status", "==", "انتظار"),
        where("date", "==", getTodayDate())
    );

    onSnapshot(q, (snap) => {
        document.getElementById('q-count').innerText = snap.size;
        const list = document.getElementById('q-list');
        list.innerHTML = "";

        if(snap.empty) {
            list.innerHTML = `<p style="padding:30px; text-align:center; color:#999;">لا يوجد مرضى بانتظارك</p>`;
        }

        snap.forEach(d => {
            const data = d.data();
            list.innerHTML += `
                <div class="q-item" onclick="startCheckup('${d.id}', '${data.name}', '${data.phone}')">
                    <div style="display:flex; justify-content:space-between">
                        <b>${data.name}</b>
                        <small style="color:var(--primary)">${data.time}</small>
                    </div>
                    <small style="color:#888">${data.phone}</small>
                </div>
            `;
        });
    });

    // --- بدء الكشف ---
    window.startCheckup = (id, name, phone) => {
        currentPatient = { id, name, phone };
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('work-area').style.display = 'block';
        document.getElementById('footer-bar').style.display = 'grid';
        document.getElementById('active-p-name').innerText = name;
        document.getElementById('active-p-phone').innerText = phone;
        
        // مسح الخانات السابقة
        document.getElementById('symptoms').value = "";
        document.getElementById('prescription').value = "";
        
        closeQueue();
    };

    // --- إنهاء الكشف وإرسال الروشتة ---
    window.savePrescription = async () => {
        if(!currentPatient) return;
        
        const symptoms = document.getElementById('symptoms').value;
        const prescription = document.getElementById('prescription').value;

        if(!prescription) return alert("برجاء كتابة الروشتة أولاً");

        try {
            // 1. حفظ الروشتة في جدول الصيدلية
            await addDoc(collection(db, "prescriptions"), {
                patientName: currentPatient.name,
                patientPhone: currentPatient.phone,
                doctor: doctorName,
                symptoms: symptoms,
                prescription: prescription,
                status: "جاهز",
                timestamp: serverTimestamp()
            });

            // 2. تحديث حالة المريض في جدول المواعيد إلى "منتهي"
            await updateDoc(doc(db, "appointments", currentPatient.id), {
                status: "منتهي"
            });

            alert("تم إرسال الروشتة بنجاح!");
            resetPage();
        } catch (e) {
            alert("حدث خطأ أثناء الحفظ، حاول مرة أخرى.");
        }
    };

    window.resetPage = () => { location.reload(); };
    window.logout = () => { localStorage.clear(); window.location.href="index.html"; };
    window.openQueue = () => { document.getElementById('queue-modal').style.display = 'flex'; };
    window.closeQueue = () => { document.getElementById('queue-modal').style.display = 'none'; };

</script>
</body>
</html>
