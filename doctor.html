<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الطبيب الذكية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #98D8C8; --secondary: #6BCB77; --dark: #2D6A4F;
            --light: #F7FFF7; --white: #ffffff; --danger: #e74c3c;
            --text-light: #6c757d; --border-color: #e0e7e5;
            --shadow: rgba(45, 106, 79, 0.1);
        }
        body {
            font-family: 'Cairo', sans-serif; background-color: var(--light);
            margin: 0; padding-bottom: 120px;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 1.5rem; }

        /* --- شريط التنقل العلوي --- */
        .doctor-nav {
            background: var(--white); padding: 1rem 1.5rem; display: flex;
            justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px var(--shadow); position: sticky; top: 0; z-index: 1000;
        }
        .doctor-info h3 { color: var(--dark); margin: 0; font-size: 1.5rem; }
        .queue-btn {
            background: var(--primary); color: var(--dark); border: none;
            padding: 0.75rem 1.5rem; border-radius: 25px; cursor: pointer;
            font-weight: 700; display: flex; align-items: center; gap: 0.5rem;
            transition: all 0.3s ease;
        }
        .queue-btn:hover { background-color: #82c9b7; }
        .queue-badge { background: var(--dark); color: var(--white); padding: 2px 10px; border-radius: 12px; font-size: 0.9rem; }

        /* --- منطقة العمل الرئيسية --- */
        #patient-welcome { text-align: center; padding: 6rem 1rem; }
        #patient-welcome i { color: var(--primary); margin-bottom: 1.5rem; }
        #patient-welcome h2 { color: var(--dark); font-size: 2rem; }
        #patient-welcome p { color: var(--text-light); }

        .patient-card {
            padding: 1.5rem; background: var(--dark); color: var(--white);
            border-radius: 15px; margin-bottom: 1.5rem;
        }
        .patient-card h3 { margin: 0; font-size: 2rem; }
        .patient-card-details { margin-top: 0.5rem; display: flex; gap: 1.5rem; opacity: 0.9; }

        .section-card {
            background: var(--white); margin-bottom: 1.5rem;
            border-radius: 15px; box-shadow: 0 5px 20px var(--shadow);
        }
        .section-header {
            padding: 1rem 1.5rem; font-weight: 700; font-size: 1.2rem;
            color: var(--dark); border-bottom: 1px solid var(--border-color);
        }
        .section-body { padding: 1.5rem; }
        .textarea-wrapper { position: relative; }
        textarea {
            width: 100%; border: 1px solid var(--border-color); border-radius: 10px;
            padding: 1rem; font-size: 1.1rem; font-family: 'Cairo', sans-serif;
            resize: vertical; min-height: 150px;
        }
        textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(152, 216, 200, 0.3); }

        /* --- زر الإملاء الصوتي --- */
        .speech-btn {
            position: absolute; left: 15px; top: 15px; background: none; border: none;
            color: #b0bec5; cursor: pointer; font-size: 1.5rem; transition: color 0.2s;
        }
        .speech-btn:hover { color: var(--secondary); }
        .speech-btn.recording { color: var(--danger); animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        /* --- الشريط السفلي للأزرار --- */
        .dock-footer {
            position: fixed; bottom: 0; width: 100%; background: var(--white);
            padding: 1rem; display: none; grid-template-columns: 1fr 1fr; gap: 1rem;
            box-shadow: 0 -4px 20px var(--shadow); z-index: 1000;
        }
        .btn {
            border: none; border-radius: 12px; cursor: pointer; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 1rem; font-size: 1.1rem; transition: all 0.3s ease;
        }
        .btn-main { background: var(--dark); color: var(--white); }
        .btn-secondary { background: var(--light); color: var(--dark); border: 1px solid var(--border-color); }
    </style>
</head>
<body>

<nav class="doctor-nav">
    <div class="doctor-info">
        <h3 id="doc-display-name">لوحة الطبيب</h3>
    </div>
    <button class="queue-btn" onclick="window.location.href='doctor_queue.html'">
        <i class="fas fa-users"></i>
        <span>قائمة الانتظار</span>
        <span class="queue-badge" id="q-count">0</span>
    </button>
</nav>

<div class="container">
    <div id="patient-welcome">
        <i class="fas fa-notes-medical fa-4x"></i>
        <h2 id="welcome-msg">مرحباً دكتور</h2>
        <p>اختر مريضاً من قائمة الانتظار لبدء الكشف</p>
    </div>

    <div id="main-work-area" style="display:none;">
        <div class="patient-card">
            <h3 id="active-p-name">---</h3>
            <div class="patient-card-details">
                <span><i class="fas fa-birthday-cake"></i> <span id="active-p-age">--</span> سنة</span>
                <span><i class="fas fa-phone"></i> <span id="active-p-phone">--</span></span>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header"><i class="fas fa-stethoscope"></i> الأعراض والتشخيص</div>
            <div class="section-body">
                <div class="textarea-wrapper">
                    <textarea id="symptoms-text" placeholder="اكتب أو اضغط على الميكروفون للتحدث..."></textarea>
                    <button class="speech-btn" id="symptoms-speech-btn" title="إملاء الأعراض"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header"><i class="fas fa-prescription"></i> الروشتة الطبية</div>
            <div class="section-body">
                 <div class="textarea-wrapper">
                    <textarea id="prescription-text" placeholder="اكتب أو اضغط على الميكروفون لإملاء الروشتة..."></textarea>
                    <button class="speech-btn" id="prescription-speech-btn" title="إملاء الروشتة"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="dock-footer" id="dock-footer">
    <button class="btn btn-secondary" onclick="viewPatientRecords()">
        <i class="fas fa-history"></i>
        سجلات المريض
    </button>
    <button class="btn btn-main" onclick="finishSession()">
        <i class="fas fa-check-circle"></i>
        إنهاء الكشف
    </button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, addDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = { /* ... ضع إعدادات Firebase الخاصة بك هنا ... */ };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const userId = localStorage.getItem('userId');
    if (!userId) window.location.href = 'login.html';

    let currentPatient = null;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let activeTextarea = null;

    async function initializePage() {
        const userDoc = await getDoc(doc(db, "users", userId));
        if (userDoc.exists()) {
            const name = userDoc.data().name;
            document.getElementById('doc-display-name').innerText = `د. ${name}`;
            document.getElementById('welcome-msg').innerText = `مرحباً د. ${name}`;
        }

        listenToQueue();

        if (SpeechRecognition) {
            setupSpeechRecognition();
        } else {
            document.querySelectorAll('.speech-btn').forEach(btn => btn.style.display = 'none');
        }

        const selectedPatientData = localStorage.getItem('selectedPatient');
        if (selectedPatientData) {
            try {
                const patient = JSON.parse(selectedPatientData);
                selectPatient(patient);
                localStorage.removeItem('selectedPatient');
            } catch (e) {
                localStorage.removeItem('selectedPatient');
            }
        }
    }

    function listenToQueue() {
        const q = query(collection(db, "appointments"), where("status", "==", "waiting"), where("doctorId", "==", userId));
        onSnapshot(q, (snap) => {
            document.getElementById('q-count').innerText = snap.size;
        });
    }

    window.selectPatient = (patientData) => {
        currentPatient = patientData;
        document.getElementById('patient-welcome').style.display = 'none';
        document.getElementById('main-work-area').style.display = 'block';
        document.getElementById('dock-footer').style.display = 'grid';
        
        document.getElementById('active-p-name').innerText = currentPatient.name;
        document.getElementById('active-p-age').innerText = currentPatient.age || '--';
        document.getElementById('active-p-phone').innerText = currentPatient.phone || '--';
        
        document.getElementById('symptoms-text').value = '';
        document.getElementById('prescription-text').value = '';
    };

    function setupSpeechRecognition() {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'ar-EG';

        recognition.onresult = (event) => {
            let final_transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    final_transcript += event.results[i][0].transcript + ' ';
                }
            }
            if (activeTextarea && final_transcript) {
                activeTextarea.value += final_transcript;
            }
        };
        
        recognition.onend = () => {
            document.querySelector('.speech-btn.recording')?.classList.remove('recording');
            activeTextarea = null;
        };

        document.getElementById('symptoms-speech-btn').onclick = () => toggleListening(document.getElementById('symptoms-text'), 'symptoms-speech-btn');
        document.getElementById('prescription-speech-btn').onclick = () => toggleListening(document.getElementById('prescription-text'), 'prescription-speech-btn');
    }

    function toggleListening(textarea, btnId) {
        const btn = document.getElementById(btnId);
        if (activeTextarea) {
            recognition.stop();
            return;
        }
        activeTextarea = textarea;
        recognition.start();
        btn.classList.add('recording');
    }

    window.finishSession = async () => {
        if (!currentPatient) return;
        const symptoms = document.getElementById('symptoms-text').value.trim();
        const prescription = document.getElementById('prescription-text').value.trim();
        if (!symptoms && !prescription) return alert('الرجاء إدخال التشخيص أو الروشتة.');
        if (!confirm(`هل أنت متأكد من إنهاء كشف ${currentPatient.name}؟`)) return;

        try {
            await addDoc(collection(db, "prescriptions"), {
                patientId: currentPatient.id,
                patientName: currentPatient.name,
                patientPhone: currentPatient.phone,
                symptoms: symptoms,
                prescription: prescription,
                doctorId: userId,
                date: new Date().toLocaleDateString('en-CA'),
                timestamp: serverTimestamp()
            });
            await updateDoc(doc(db, "appointments", currentPatient.id), { status: "منتهي" });
            alert('✓ تم إنهاء الكشف بنجاح.');
            window.location.reload(); // إعادة تحميل الصفحة للعودة للحالة الأولية
        } catch (e) {
            alert("خطأ في الحفظ: " + e.message);
        }
    };

    window.viewPatientRecords = () => {
        if (!currentPatient) return;
        // تخزين بيانات المريض للانتقال بها إلى صفحة السجلات
        localStorage.setItem('patientForRecords', JSON.stringify({
            name: currentPatient.name,
            phone: currentPatient.phone
        }));
        // فتح صفحة السجلات في نافذة جديدة
        window.open('patient_records.html', '_blank');
    };

    initializePage();
</script>
</body>
</html>
