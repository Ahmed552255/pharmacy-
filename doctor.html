<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الطبيب</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #45b39d; --dark: #16a085; --light: #f4fbf9; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; padding: 15px; }
        .doctor-nav { display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 10px 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .patient-list { list-style: none; padding: 0; margin: 0; }
        .patient-list li { background: var(--white); padding: 20px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
    </style>
</head>
<body>
    <nav class="doctor-nav">
        <div>
            <h2 style="margin:0; color:var(--dark)"><i class="fas fa-user-md"></i> لوحة الطبيب</h2>
            <small id="doc-display-name"></small>
        </div>
        <button onclick="logout()" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> خروج</button>
    </nav>
    <ul id="patients-queue" class="patient-list">
        <!-- سيتم ملء قائمة المرضى هنا -->
    </ul>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBTM1aa1cF0gyeLoKLlJPuYgystJ_Q3b_Q",
            authDomain: "slave-table.firebaseapp.com",
            projectId: "slave-table",
            storageBucket: "slave-table.firebasestorage.app",
            messagingSenderId: "827430776658",
            appId: "1:827430776658:web:b8301d16116f641359548b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const doctorName = localStorage.getItem('doctorName');
        if (!doctorName) {
            alert("بيانات الطبيب غير موجودة! سيتم إعادتك لصفحة تسجيل الدخول.");
            window.location.href = 'index.html';
        }

        document.getElementById('doc-display-name').innerText = `د. ${doctorName}`;

        const q = query(
            collection(db, "appointments"), 
            where("status", "==", "انتظار"), 
            where("doctor", "==", doctorName)
        );

        onSnapshot(q, (snap) => {
            const queueList = document.getElementById('patients-queue');
            queueList.innerHTML = snap.empty ? `<li style="text-align:center; color:#888;">لا يوجد مرضى في الانتظار حالياً.</li>` : "";
            snap.forEach(d => {
                const patient = d.data();
                queueList.innerHTML += `
                    <li>
                        <span><strong>${patient.name}</strong></span>
                        <button class="btn btn-primary" onclick="finishSession('${d.id}')">
                            <i class="fas fa-check-circle"></i> إنهاء الكشف
                        </button>
                    </li>
                `;
            });
        });

        window.finishSession = async (appointmentId) => {
            if (confirm("هل أنت متأكد من إنهاء هذا الكشف؟")) {
                try {
                    await updateDoc(doc(db, "appointments", appointmentId), { status: "منتهي" });
                    alert("تم إنهاء الكشف بنجاح.");
                } catch (e) {
                    alert("فشل تحديث الحالة: " + e.message);
                }
            }
        };

        window.logout = () => {
            localStorage.clear();
            window.location.href = 'index.html';
        };
    </script>
</body>
</html>
