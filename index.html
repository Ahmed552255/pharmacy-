<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ | Ù†Ø¸Ø§Ù… ØµÙŠØ¯Ù„ÙŠØ© ÙˆØ¹ÙŠØ§Ø¯Ø§Øª ÙÙ‚ÙŠÙ‡Ø§</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #45b39d;
            --dark-teal: #00796b;
            --soft-bg: #f0f4f8;
            --white: #ffffff;
            --error: #e74c3c;
            --success: #27ae60;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark-teal) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        .login-container {
            background: var(--white);
            padding: 30px 25px;
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 420px;
            text-align: center;
            position: relative;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-circle {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--dark-teal));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: -60px auto 20px auto;
            border: 5px solid var(--white);
            color: var(--white);
            font-size: 35px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: clamp(20px, 5vw, 26px);
        }

        .subtitle {
            color: #7f8c8d;
            font-size: clamp(12px, 3vw, 14px);
            margin-bottom: 25px;
        }

        .input-group {
            position: relative;
            margin-bottom: 18px;
            text-align: right;
        }

        .input-group i {
            position: absolute;
            right: 15px;
            top: 43px;
            color: var(--primary);
            z-index: 1;
            font-size: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: clamp(13px, 3vw, 14px);
            text-align: right;
        }

        input, select {
            width: 100%;
            padding: 13px 45px 13px 15px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            font-size: clamp(14px, 3.5vw, 16px);
            outline: none;
            transition: all 0.3s;
            background: #fafafa;
        }

        input:focus, select:focus {
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(69, 179, 157, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--dark-teal));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: clamp(16px, 4vw, 18px);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }

        .login-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .login-btn .spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .login-btn.loading .btn-text { display: none; }
        .login-btn.loading .spinner { display: block; }

        .toggle-link {
            display: block;
            margin-top: 20px;
            color: var(--primary);
            cursor: pointer;
            font-size: clamp(13px, 3vw, 14px);
            font-weight: 600;
            transition: color 0.3s;
        }

        .toggle-link:hover {
            color: var(--dark-teal);
            text-decoration: underline;
        }

        .footer-text {
            margin-top: 25px;
            font-size: clamp(11px, 2.5vw, 12px);
            color: #95a5a6;
            line-height: 1.6;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: clamp(13px, 3vw, 14px);
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert.error {
            background: #ffe5e5;
            color: var(--error);
            border: 1px solid var(--error);
        }

        .alert.success {
            background: #d4edda;
            color: var(--success);
            border: 1px solid var(--success);
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .password-toggle {
            position: absolute;
            left: 15px;
            top: 43px;
            cursor: pointer;
            color: #7f8c8d;
            z-index: 2;
        }

        .password-toggle:hover {
            color: var(--primary);
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .login-container {
                padding: 25px 20px;
                border-radius: 20px;
            }

            .logo-circle {
                width: 70px;
                height: 70px;
                font-size: 30px;
                margin-top: -55px;
            }

            .input-group {
                margin-bottom: 15px;
            }

            input, select {
                padding: 12px 40px 12px 12px;
            }
        }

        @media (max-width: 360px) {
            .logo-circle {
                width: 60px;
                height: 60px;
                font-size: 26px;
            }
        }

        /* Ù…ÙŠØ²Ø© Ø¥Ø¶Ø§ÙÙŠØ©: Ù…Ø¤Ø´Ø± Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± */
        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }

        .password-strength-bar {
            height: 100%;
            width: 0;
            transition: all 0.3s;
            border-radius: 2px;
        }

        .strength-weak { width: 33%; background: #e74c3c; }
        .strength-medium { width: 66%; background: #f39c12; }
        .strength-strong { width: 100%; background: #27ae60; }

        .password-hint {
            font-size: 11px;
            color: #7f8c8d;
            text-align: right;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>

    <div class="login-container">
        <div class="logo-circle">
            <i class="fas fa-clinic-medical"></i>
        </div>
        
        <h2 id="form-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <p class="subtitle" id="form-subtitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… ØµÙŠØ¯Ù„ÙŠØ© ÙˆØ¹ÙŠØ§Ø¯Ø§Øª ÙÙ‚ÙŠÙ‡Ø§</p>

        <div class="alert" id="alert"></div>

        <form id="authForm">
            <!-- Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙ‚Ø·) -->
            <div class="input-group hidden" id="name-group">
                <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                <i class="fas fa-user"></i>
                <input type="text" id="fullname" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
            </div>

            <!-- Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ -->
            <div class="input-group">
                <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <i class="fas fa-envelope"></i>
                <input type="email" id="email" placeholder="example@clinic.com" required autocomplete="email">
            </div>

            <!-- ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± -->
            <div class="input-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <i class="fas fa-lock"></i>
                <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required autocomplete="current-password">
                <i class="fas fa-eye password-toggle" id="togglePassword"></i>
                <div class="password-strength" id="passwordStrength">
                    <div class="password-strength-bar" id="strengthBar"></div>
                </div>
                <div class="password-hint" id="passwordHint">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</div>
            </div>
            
            <!-- Ø§Ù„ÙˆØ¸ÙŠÙØ© (Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙ‚Ø·) -->
            <div class="input-group hidden" id="role-group">
                <label>Ø§Ù„ÙˆØ¸ÙŠÙØ©</label>
                <i class="fas fa-user-tag"></i>
                <select id="role">
                    <option value="" disabled selected>Ø§Ø®ØªØ± ÙˆØ¸ÙŠÙØªÙƒ</option>
                    <option value="attendant">Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ / ØªÙ…Ø±ÙŠØ¶</option>
                    <option value="doctor">Ø·Ø¨ÙŠØ¨</option>
                    <option value="pharmacist">ØµÙŠØ¯Ù„ÙŠ</option>
                </select>
            </div>

            <!-- Ø§Ù„ØªØ®ØµØµ (Ù„Ù„Ø£Ø·Ø¨Ø§Ø¡ ÙÙ‚Ø·) -->
            <div class="input-group hidden" id="specialty-group">
                <label>Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø·Ø¨ÙŠ</label>
                <i class="fas fa-stethoscope"></i>
                <select id="specialty">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØ®ØµØµ</option>
                    <option value="Ø¨Ø§Ø·Ù†Ø©">Ø¨Ø§Ø·Ù†Ø©</option>
                    <option value="Ø£Ø·ÙØ§Ù„">Ø£Ø·ÙØ§Ù„</option>
                    <option value="Ø¹Ø¸Ø§Ù…">Ø¹Ø¸Ø§Ù…</option>
                    <option value="Ù‚Ù„Ø¨ ÙˆØ£ÙˆØ¹ÙŠØ© Ø¯Ù…ÙˆÙŠØ©">Ù‚Ù„Ø¨ ÙˆØ£ÙˆØ¹ÙŠØ© Ø¯Ù…ÙˆÙŠØ©</option>
                    <option value="Ø¬Ø±Ø§Ø­Ø© Ø¹Ø§Ù…Ø©">Ø¬Ø±Ø§Ø­Ø© Ø¹Ø§Ù…Ø©</option>
                    <option value="Ø£Ù†Ù ÙˆØ£Ø°Ù† ÙˆØ­Ù†Ø¬Ø±Ø©">Ø£Ù†Ù ÙˆØ£Ø°Ù† ÙˆØ­Ù†Ø¬Ø±Ø©</option>
                    <option value="Ù†Ø³Ø§Ø¡ ÙˆØªÙˆÙ„ÙŠØ¯">Ù†Ø³Ø§Ø¡ ÙˆØªÙˆÙ„ÙŠØ¯</option>
                    <option value="Ø¬Ù„Ø¯ÙŠØ©">Ø¬Ù„Ø¯ÙŠØ©</option>
                    <option value="Ø£Ø³Ù†Ø§Ù†">Ø£Ø³Ù†Ø§Ù†</option>
                    <option value="Ø¹ÙŠÙˆÙ†">Ø¹ÙŠÙˆÙ†</option>
                </select>
            </div>

            <!-- Ø±Ø¨Ø· Ù…Ø¹ Ø·Ø¨ÙŠØ¨ (Ù„Ù„Ù…Ù…Ø±Ø¶ ÙÙ‚Ø·) -->
            <div class="input-group hidden" id="doctor-link-group">
                <label>Ø±Ø¨Ø· Ù…Ø¹ Ø·Ø¨ÙŠØ¨</label>
                <i class="fas fa-user-md"></i>
                <select id="linked-doctor">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</option>
                </select>
            </div>

            <button type="submit" class="login-btn" id="auth-button">
                <span class="btn-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                <div class="spinner"></div>
            </button>

            <a class="toggle-link" id="toggle-auth">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</a>
        </form>

        <div class="footer-text">
            Â© 2025 ØµÙŠØ¯Ù„ÙŠØ© ÙˆØ¹ÙŠØ§Ø¯Ø§Øª ÙÙ‚ÙŠÙ‡Ø§<br>
            Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø·Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBy8xPvxQuC6bVLerLpSjzPmvBWyAhuYKo",
            authDomain: "mogama-49e7f.firebaseapp.com",
            projectId: "mogama-49e7f",
            storageBucket: "mogama-49e7f.firebasestorage.app",
            messagingSenderId: "575066177594",
            appId: "1:575066177594:web:82137834158b4c353db503"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
        const elements = {
            form: document.getElementById('authForm'),
            email: document.getElementById('email'),
            password: document.getElementById('password'),
            fullname: document.getElementById('fullname'),
            role: document.getElementById('role'),
            specialty: document.getElementById('specialty'),
            linkedDoctor: document.getElementById('linked-doctor'),
            authButton: document.getElementById('auth-button'),
            toggleLink: document.getElementById('toggle-auth'),
            alert: document.getElementById('alert'),
            formTitle: document.getElementById('form-title'),
            formSubtitle: document.getElementById('form-subtitle'),
            nameGroup: document.getElementById('name-group'),
            roleGroup: document.getElementById('role-group'),
            specialtyGroup: document.getElementById('specialty-group'),
            doctorLinkGroup: document.getElementById('doctor-link-group'),
            togglePassword: document.getElementById('togglePassword'),
            passwordStrength: document.getElementById('passwordStrength'),
            strengthBar: document.getElementById('strengthBar'),
            passwordHint: document.getElementById('passwordHint')
        };

        const REDIRECT_MAP = {
            'attendant': 'index.html',
            'doctor': 'doctor.html',
            'pharmacist': 'pharmacy_main.html'
        };

        let isRegistering = false;

        // ÙˆØ¸ÙŠÙØ© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function showAlert(message, type = 'error') {
            elements.alert.textContent = message;
            elements.alert.className = `alert ${type}`;
            elements.alert.style.display = 'block';
            setTimeout(() => {
                elements.alert.style.display = 'none';
            }, 5000);
        }

        // ÙˆØ¸ÙŠÙØ© ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        elements.togglePassword.addEventListener('click', () => {
            const type = elements.password.type === 'password' ? 'text' : 'password';
            elements.password.type = type;
            elements.togglePassword.classList.toggle('fa-eye');
            elements.togglePassword.classList.toggle('fa-eye-slash');
        });

        // Ù…ÙŠØ²Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ù…Ø¤Ø´Ø± Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        elements.password.addEventListener('input', (e) => {
            const password = e.target.value;
            
            if (isRegistering && password.length > 0) {
                elements.passwordStrength.style.display = 'block';
                elements.passwordHint.style.display = 'block';
                
                let strength = 0;
                if (password.length >= 6) strength++;
                if (password.length >= 10) strength++;
                if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^a-zA-Z0-9]/.test(password)) strength++;
                
                elements.strengthBar.className = 'password-strength-bar';
                if (strength <= 2) {
                    elements.strengthBar.classList.add('strength-weak');
                    elements.passwordHint.textContent = 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©';
                    elements.passwordHint.style.color = '#e74c3c';
                } else if (strength <= 3) {
                    elements.strengthBar.classList.add('strength-medium');
                    elements.passwordHint.textContent = 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…ØªÙˆØ³Ø·Ø©';
                    elements.passwordHint.style.color = '#f39c12';
                } else {
                    elements.strengthBar.classList.add('strength-strong');
                    elements.passwordHint.textContent = 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©';
                    elements.passwordHint.style.color = '#27ae60';
                }
            } else {
                elements.passwordStrength.style.display = 'none';
                elements.passwordHint.style.display = 'none';
            }
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function fetchDoctors() {
            try {
                const q = query(collection(db, "users"), where("role", "==", "doctor"));
                const querySnapshot = await getDocs(q);
                
                elements.linkedDoctor.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</option>';
                
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const doctorName = data.name || data.email.split('@')[0];
                    const specialty = data.specialty ? ` - ${data.specialty}` : '';
                    elements.linkedDoctor.innerHTML += `
                        <option value="${docSnap.id}">${doctorName}${specialty}</option>
                    `;
                });
                
                if (querySnapshot.empty) {
                    elements.linkedDoctor.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ†</option>';
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡:', error);
                elements.linkedDoctor.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>';
            }
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¸ÙŠÙØ©
        elements.role.addEventListener('change', (e) => {
            const role = e.target.value;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
            elements.specialtyGroup.classList.add('hidden');
            elements.doctorLinkGroup.classList.add('hidden');
            
            if (role === 'doctor') {
                elements.specialtyGroup.classList.remove('hidden');
                elements.specialtyGroup.classList.add('fade-in');
            } else if (role === 'attendant') {
                elements.doctorLinkGroup.classList.remove('hidden');
                elements.doctorLinkGroup.classList.add('fade-in');
                fetchDoctors();
            }
        });

        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
        elements.toggleLink.addEventListener('click', () => {
            isRegistering = !isRegistering;
            
            if (isRegistering) {
                elements.formTitle.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
                elements.formSubtitle.textContent = 'Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª';
                elements.nameGroup.classList.remove('hidden');
                elements.roleGroup.classList.remove('hidden');
                elements.authButton.querySelector('.btn-text').textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
                elements.toggleLink.textContent = 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„';
                elements.password.setAttribute('autocomplete', 'new-password');
            } else {
                elements.formTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                elements.formSubtitle.textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… ØµÙŠØ¯Ù„ÙŠØ© ÙˆØ¹ÙŠØ§Ø¯Ø§Øª ÙÙ‚ÙŠÙ‡Ø§';
                elements.nameGroup.classList.add('hidden');
                elements.roleGroup.classList.add('hidden');
                elements.specialtyGroup.classList.add('hidden');
                elements.doctorLinkGroup.classList.add('hidden');
                elements.authButton.querySelector('.btn-text').textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                elements.toggleLink.textContent = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†';
                elements.password.setAttribute('autocomplete', 'current-password');
                elements.passwordStrength.style.display = 'none';
                elements.passwordHint.style.display = 'none';
            }
            
            // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
            elements.form.reset();
            elements.alert.style.display = 'none';
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function validateInputs() {
            const email = elements.email.value.trim();
            const password = elements.password.value;
            
            if (!email || !password) {
                showAlert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return false;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­');
                return false;
            }
            
            if (password.length < 6) {
                showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return false;
            }
            
            if (isRegistering) {
                const fullname = elements.fullname.value.trim();
                const role = elements.role.value;
                
                if (!fullname) {
                    showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„');
                    return false;
                }
                
                if (!role) {
                    showAlert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¸ÙŠÙØ©');
                    return false;
                }
                
                if (role === 'doctor' && !elements.specialty.value) {
                    showAlert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø·Ø¨ÙŠ');
                    return false;
                }
                
                if (role === 'attendant' && !elements.linkedDoctor.value) {
                    showAlert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„');
                    return false;
                }
            }
            
            return true;
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function handleLogin(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const userDoc = await getDoc(doc(db, "users", userCredential.user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    localStorage.setItem('userId', userCredential.user.uid);
                    localStorage.setItem('userRole', userData.role);
                    localStorage.setItem('userEmail', email);
                    
                    if (userData.name) {
                        localStorage.setItem('userName', userData.name);
                    }
                    
                    if (userData.specialty) {
                        localStorage.setItem('userSpecialty', userData.specialty);
                    }
                    
                    if (userData.linkedDoctor) {
                        // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
                        const doctorDoc = await getDoc(doc(db, "users", userData.linkedDoctor));
                        if (doctorDoc.exists()) {
                            localStorage.setItem('linkedDoctorName', doctorDoc.data().name);
                            localStorage.setItem('linkedDoctorId', userData.linkedDoctor);
                        }
                    }
                    
                    showAlert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    
                    setTimeout(() => {
                        window.location.href = REDIRECT_MAP[userData.role];
                    }, 1000);
                } else {
                    showAlert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                
                let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                }
                
                showAlert(errorMessage);
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
        async function handleRegister(email, password) {
            try {
                const fullname = elements.fullname.value.trim();
                const role = elements.role.value;
                const specialty = elements.specialty.value;
                const linkedDoctor = elements.linkedDoctor.value;
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
                const userData = {
                    email,
                    name: fullname,
                    role,
                    createdAt: new Date().toISOString()
                };
                
                if (specialty) {
                    userData.specialty = specialty;
                }
                
                if (linkedDoctor) {
                    userData.linkedDoctor = linkedDoctor;
                }
                
                await setDoc(doc(db, "users", userCredential.user.uid), userData);
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠØ§Ù‹
                localStorage.setItem('userId', userCredential.user.uid);
                localStorage.setItem('userRole', role);
                localStorage.setItem('userName', fullname);
                localStorage.setItem('userEmail', email);
                
                if (specialty) {
                    localStorage.setItem('userSpecialty', specialty);
                }
                
                if (linkedDoctor) {
                    const doctorDoc = await getDoc(doc(db, "users", linkedDoctor));
                    if (doctorDoc.exists()) {
                        localStorage.setItem('linkedDoctorName', doctorDoc.data().name);
                        localStorage.setItem('linkedDoctorId', linkedDoctor);
                    }
                }
                
                showAlert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                setTimeout(() => {
                    window.location.href = REDIRECT_MAP[role];
                }, 1500);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨:', error);
                
                let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                }
                
                showAlert(errorMessage);
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        elements.form.addEventListener('submit', async (e) => {
            e.preventDefault();
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (!validateInputs()) {
                return;
            }
            
            const email = elements.email.value.trim();
            const password = elements.password.value;
            
            // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            elements.authButton.disabled = true;
            elements.authButton.classList.add('loading');
            elements.alert.style.display = 'none';
            
            try {
                if (isRegistering) {
                    await handleRegister(email, password);
                } else {
                    await handleLogin(email, password);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
            } finally {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
                elements.authButton.disabled = false;
                elements.authButton.classList.remove('loading');
            }
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚
        auth.onAuthStateChanged(async (user) => {
            if (user && !isRegistering) {
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (REDIRECT_MAP[userData.role]) {
                            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
                            window.location.href = REDIRECT_MAP[userData.role];
                        }
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚:', error);
                }
            }
        });

        // Ù…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter ÙÙŠ Ø­Ù‚ÙˆÙ„ Select
        elements.role.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });

        elements.specialty.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });

        elements.linkedDoctor.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });

        // Ù…ÙŠØ²Ø© Ø¥Ø¶Ø§ÙÙŠØ©: Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (ØªØ°ÙƒØ±Ù†ÙŠ)
        const savedEmail = localStorage.getItem('savedEmail');
        if (savedEmail) {
            elements.email.value = savedEmail;
        }

        elements.form.addEventListener('submit', () => {
            if (!isRegistering) {
                localStorage.setItem('savedEmail', elements.email.value.trim());
            }
        });

        // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
        const originalReset = elements.form.reset.bind(elements.form);
        elements.form.reset = function() {
            originalReset();
            elements.passwordStrength.style.display = 'none';
            elements.passwordHint.style.display = 'none';
            elements.password.type = 'password';
            elements.togglePassword.classList.remove('fa-eye-slash');
            elements.togglePassword.classList.add('fa-eye');
        };

        // Ù…ÙŠØ²Ø© Ø¥Ø¶Ø§ÙÙŠØ©: Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù„ØºØ© ÙˆØ¯Ø¹Ù… RTL/LTR
        document.addEventListener('DOMContentLoaded', () => {
            const isRTL = document.dir === 'rtl';
            if (!isRTL) {
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ø­ØªØ¬Ù†Ø§ Ø¯Ø¹Ù… Ù„ØºØ§Øª Ø£Ø®Ø±Ù‰
                document.querySelectorAll('input, select').forEach(el => {
                    el.style.textAlign = 'right';
                });
            }
        });

        // Ù…Ù†Ø¹ Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ù„ØµÙ‚ ÙÙŠ Ø­Ù‚Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø£Ù…Ø§Ù† Ø¥Ø¶Ø§ÙÙŠ - Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        // ÙŠÙ…ÙƒÙ† Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ù„ØµÙ‚
        /*
        elements.password.addEventListener('paste', (e) => {
            if (isRegistering) {
                e.preventDefault();
                showAlert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„ØµÙ‚ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
            }
        });
        */

        // Ù…ÙŠØ²Ø©: Escape Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && elements.alert.style.display === 'block') {
                elements.alert.style.display = 'none';
            }
        });

        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª ØµÙˆØªÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        function playSuccessSound() {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØµÙˆØª Ù†Ø¬Ø§Ø­ Ù‡Ù†Ø§
            // const audio = new Audio('success.mp3');
            // audio.play();
        }

        // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: Debounce Ù„ÙØ­Øµ Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… debounce Ù…Ø¹ ÙØ­Øµ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const debouncedPasswordCheck = debounce((password) => {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙØ­ÙˆØµØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§
            console.log('Checking password strength...');
        }, 300);

        elements.password.addEventListener('input', (e) => {
            debouncedPasswordCheck(e.target.value);
        });

        // Ù…ÙŠØ²Ø©: Ø§Ù‚ØªØ±Ø§Ø­ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©
        function generateStrongPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù„ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©
        // const generateBtn = document.createElement('button');
        // generateBtn.textContent = 'ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©';
        // generateBtn.onclick = () => elements.password.value = generateStrongPassword();

        console.log('âœ… Ù†Ø¸Ø§Ù… ØµÙŠØ¯Ù„ÙŠØ© ÙˆØ¹ÙŠØ§Ø¯Ø§Øª ÙÙ‚ÙŠÙ‡Ø§ - ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        console.log('ğŸ“± Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©');
        console.log('ğŸ”’ Ù†Ø¸Ø§Ù… Ø¢Ù…Ù† ÙˆÙ…Ø´ÙØ±');
    </script>
</body>
</html>
