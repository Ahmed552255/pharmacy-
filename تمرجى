<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¹ÙŠØ§Ø¯Ø§Øª ÙÙ‚ÙŠÙ‡Ø§ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            deleteDoc, 
            doc, 
            query, 
            orderBy, 
            onSnapshot,
            serverTimestamp,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBy8xPvxQuC6bVLerLpSjzPmvBWyAhuYKo",
            authDomain: "mogama-49e7f.firebaseapp.com",
            projectId: "mogama-49e7f",
            storageBucket: "mogama-49e7f.firebasestorage.app",
            messagingSenderId: "575066177594",
            appId: "1:575066177594:web:82137834158b4c353db503",
            measurementId: "G-LDV17XLK65"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        
        // Ø¬Ø¹Ù„ Ù…ØªØºÙŠØ±Ø§Øª Firebase Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
        window.firebaseApp = app;
        window.firebaseDB = db;
        window.firebaseFunctions = {
            collection, addDoc, getDocs, deleteDoc, doc, query, 
            orderBy, onSnapshot, serverTimestamp, updateDoc
        };
    </script>

    <style>
        :root { 
            --baby-green: #d1f2eb; 
            --primary-green: #45b39d; 
            --dark-green: #16a085;
            --white: #ffffff; 
            --text: #2c3e50; 
            --light-gray: #f8f9fa;
            --border-color: #e0e0e0;
        }
        
        body { 
            font-family: 'Segoe UI', 'Tahoma', Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #f4fbf9 0%, #e8f6f3 100%);
            color: var(--text); 
            margin: 0; 
            padding: 10px;
            min-height: 100vh;
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .header h2 { 
            color: var(--primary-green); 
            margin-bottom: 5px;
            font-size: 28px;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .status-connected {
            background: #e8f6ef;
            color: #27ae60;
            border: 1px solid #2ecc71;
        }
        
        .status-disconnected {
            background: #fdedec;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .connected { background: #2ecc71; animation: pulse 2s infinite; }
        .disconnected { background: #e74c3c; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .search-container { 
            max-width: 1000px; 
            margin: 0 auto 20px auto; 
            position: relative; 
        }
        
        .search-container input { 
            width: 100%; 
            padding: 15px 50px 15px 20px; 
            border-radius: 30px; 
            border: 2px solid var(--baby-green); 
            outline: none; 
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .search-container input:focus { 
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(69, 179, 157, 0.2);
        }
        
        .search-container i { 
            position: absolute; 
            right: 20px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--primary-green); 
            font-size: 18px;
        }
        
        .controls { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            justify-content: center; 
            max-width: 1000px; 
            margin: 0 auto 20px auto; 
        }
        
        .btn { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 600; 
            background: var(--white); 
            border: 1px solid var(--baby-green); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: all 0.3s;
            font-size: 15px;
        }
        
        .btn:hover { 
            background: var(--baby-green); 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .btn-add { 
            background: linear-gradient(135deg, var(--primary-green), var(--dark-green)); 
            color: white; 
            border: none;
            box-shadow: 0 4px 15px rgba(69, 179, 157, 0.3);
        }
        
        .btn-add:hover { 
            background: linear-gradient(135deg, var(--dark-green), var(--primary-green));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(69, 179, 157, 0.4);
        }
        
        .table-card { 
            background: white; 
            border-radius: 15px; 
            overflow-x: auto; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            max-width: 1100px; 
            margin: auto;
            padding: 5px;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 900px; 
        }
        
        th { 
            background: linear-gradient(135deg, var(--baby-green), #e8f6f3); 
            color: var(--dark-green); 
            padding: 16px 12px; 
            font-weight: 600;
            text-align: center;
            border-bottom: 2px solid var(--primary-green);
        }
        
        td { 
            padding: 14px 12px; 
            text-align: center; 
            border-bottom: 1px solid var(--border-color); 
        }
        
        tbody tr:nth-child(even) { 
            background-color: #fafffe; 
        }
        
        tbody tr:hover { 
            background-color: #f0f9f7; 
            transition: background-color 0.2s;
        }
        
        .status-select {
            border: none; 
            background: transparent; 
            font-weight: bold; 
            font-size: 14px;
            padding: 5px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }
        
        .status-waiting { color: #f39c12; background: #fef9e7; }
        .status-checked { color: #3498db; background: #ebf5fb; }
        .status-finished { color: #27ae60; background: #e8f6ef; }
        
        .status-select:hover {
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
        }
        
        #searchResults { 
            position: absolute; 
            width: 100%; 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            z-index: 100; 
            max-height: 300px; 
            overflow-y: auto; 
            display: none; 
            margin-top: 5px;
            border: 1px solid var(--border-color);
        }
        
        .search-item { 
            padding: 12px 15px; 
            border-bottom: 1px solid var(--border-color); 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            transition: background 0.2s;
        }
        
        .search-item:hover { 
            background: var(--baby-green); 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
            padding: 10px;
            backdrop-filter: blur(3px);
        }
        
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 600px; 
            position: relative; 
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            animation: modalFade 0.3s ease-out;
        }
        
        @keyframes modalFade {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group { 
            margin-bottom: 15px; 
            text-align: right; 
        }
        
        .form-group label { 
            display: block; 
            font-weight: bold; 
            margin-bottom: 8px; 
            color: var(--primary-green); 
            font-size: 15px;
        }
        
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            box-sizing: border-box;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus { 
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(69, 179, 157, 0.2);
            outline: none;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .close-btn { 
            position: absolute; 
            left: 20px; 
            top: 20px; 
            background: none; 
            border: none; 
            font-size: 20px; 
            cursor: pointer; 
            color: #999;
            transition: color 0.3s;
        }
        
        .close-btn:hover { 
            color: var(--primary-green); 
        }
        
        .stat-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 14px 10px; 
            border-bottom: 1px solid #eee; 
            align-items: center;
        }
        
        .loader {
            text-align: center;
            padding: 30px;
            color: var(--primary-green);
        }
        
        .loader i {
            font-size: 30px;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--baby-green);
        }
        
        .firebase-badge {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            color: #666;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <h2><i class="fas fa-clinic-medical"></i> Ø¹ÙŠØ§Ø¯Ø§Øª ÙÙ‚ÙŠÙ‡Ø§</h2>
        <p id="todayDate"></p>
        <div id="connectionStatus" class="connection-status status-disconnected">
            <span class="status-dot disconnected"></span>
            <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
        </div>
    </div>

    <div class="search-container">
        <i class="fa fa-search"></i>
        <input type="text" id="masterSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." 
               onkeyup="globalSearch(this.value)">
        <div id="searchResults"></div>
    </div>

    <div class="controls">
        <button class="btn btn-add" onclick="toggleModal('addModal', true)">
            <i class="fa fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯
        </button>
        <button class="btn" onclick="showStats()">
            <i class="fa fa-chart-bar"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        </button>
        <button class="btn" onclick="showHistory()">
            <i class="fa fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
        </button>
        <button class="btn" onclick="exportToday()" style="color: #2980b9;">
            <i class="fa fa-download"></i> ØªØµØ¯ÙŠØ± Ø§Ù„ÙŠÙˆÙ…
        </button>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</th>
                    <th>Ø§Ù„Ø¹Ù…Ø±</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th>Ø§Ù„Ø¯ÙƒØªÙˆØ±</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„Ù…ÙˆØ¹Ø¯</th>
                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                    <th>Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="todayTable">
                <tr>
                    <td colspan="9" class="loader">
                        <i class="fas fa-spinner"></i><br>
                        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯ -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="toggleModal('addModal', false)">
                <i class="fas fa-times"></i>
            </button>
            <h3 style="text-align:center; color:var(--primary-green); margin-bottom:25px;">
                <i class="fas fa-user-plus"></i> Ø­Ø¬Ø² ÙƒØ´Ù Ø¬Ø¯ÙŠØ¯
            </h3>
            
            <div class="form-group">
                <label><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label>
                <input type="text" id="pName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label><i class="fas fa-birthday-cake"></i> Ø§Ù„Ø¹Ù…Ø±</label>
                    <input type="number" id="pAge" placeholder="Ø§Ù„Ø¹Ù…Ø±" min="1" max="120">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="pPhone" placeholder="Ù…Ø«Ø§Ù„: 01001234567">
                </div>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-user-md"></i> Ø§Ù„Ø¯ÙƒØªÙˆØ±</label>
                <select id="pDoc">
                    <option>Ø¯ÙƒØªÙˆØ± Ø±Ø£ÙØª ÙØªØ­ Ø§Ù„Ø¨Ø§Ø¨</option>
                    <option>Ø¯ÙƒØªÙˆØ± Ø²ÙŠÙ† Ø³Ø¹Ø¯ Ø²ÙŠÙ†</option>
                    <option>Ø¯ÙƒØªÙˆØ± Ù…Ø­Ù…ÙˆØ¯ Ù‚Ø±Ø´ÙŠ</option>
                    <option>Ø¯ÙƒØªÙˆØ± ÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…ÙŠØ±ÙŠ</option>
                    <option>Ø¯ÙƒØªÙˆØ± Ù…Ø­Ù…ÙˆØ¯ Ø±Ù…Ø¶Ø§Ù†</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)</label>
                    <input type="number" id="pPrice" value="200" min="0">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-clock"></i> ÙˆÙ‚Øª Ø§Ù„Ù…ÙˆØ¹Ø¯</label>
                    <input type="time" id="pTime">
                </div>
            </div>
            
            <button class="btn btn-add" style="width:100%; padding:16px; font-size:16px; margin-top:10px;" 
                    onclick="addPatientToFirebase()">
                <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø² ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            
            <p onclick="toggleModal('addModal', false)" 
               style="text-align:center; color:#666; cursor:pointer; margin-top:15px; font-size:14px;">
               <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
            </p>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <div id="infoModal" class="modal">
        <div class="modal-content" id="infoContent"></div>
    </div>

    <div class="firebase-badge">
        <i class="fas fa-database" style="color:#FFA000;"></i>
        <span>Firebase Connected</span>
    </div>

    <script>
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let patients = [];
        let currentStats = {
            totalPatients: 0,
            totalRevenue: 0,
            byDoctor: {}
        };
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ¸Ø§Ø¦Ù Firebase
        const { 
            collection, addDoc, getDocs, deleteDoc, doc, 
            query, orderBy, onSnapshot, serverTimestamp, updateDoc 
        } = window.firebaseFunctions;
        
        const db = window.firebaseDB;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
        document.getElementById('todayDate').innerText = new Date().toLocaleDateString('ar-EG', {
            weekday: 'long', 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric'
        });
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        document.addEventListener('DOMContentLoaded', function() {
            setupFirebaseListener();
        });
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Firebase
        async function setupFirebaseListener() {
            try {
                const patientsCollection = collection(db, "patients");
                const today = new Date().toLocaleDateString('ar-EG', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·
                const q = query(patientsCollection, orderBy("timestamp", "desc"));
                
                // Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                onSnapshot(q, (snapshot) => {
                    patients = [];
                    snapshot.forEach((docSnapshot) => {
                        const data = docSnapshot.data();
                        // ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙŠÙˆÙ…
                        if (data.dateCreated === today || !data.dateCreated) {
                            patients.push({
                                id: docSnapshot.id,
                                ...data
                            });
                        }
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    updateUI();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                    updateConnectionStatus(true);
                });
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
                updateConnectionStatus(false);
                showError("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateConnectionStatus(isConnected) {
            const statusEl = document.getElementById('connectionStatus');
            if (isConnected) {
                statusEl.className = "connection-status status-connected";
                statusEl.innerHTML = `<span class="status-dot connected"></span>
                                     <span>Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (${patients.length} Ø­Ø§Ù„Ø©)</span>`;
            } else {
                statusEl.className = "connection-status status-disconnected";
                statusEl.innerHTML = `<span class="status-dot disconnected"></span>
                                     <span>ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>`;
            }
        }
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        function showError(message) {
            const tbody = document.getElementById('todayTable');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="color: #e74c3c; padding: 30px; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 40px; margin-bottom: 10px;"></i><br>
                        ${message}
                    </td>
                </tr>
            `;
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Firebase
        async function addPatientToFirebase() {
            const name = document.getElementById('pName').value.trim();
            const age = document.getElementById('pAge').value;
            const phone = document.getElementById('pPhone').value.trim();
            const doctor = document.getElementById('pDoc').value;
            const price = parseFloat(document.getElementById('pPrice').value) || 200;
            const time = document.getElementById('pTime').value || new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
            
            if (!name) {
                alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶");
                document.getElementById('pName').focus();
                return;
            }
            
            if (!phone) {
                alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
                document.getElementById('pPhone').focus();
                return;
            }
            
            const patientData = {
                name: name,
                age: parseInt(age) || 0,
                phone: phone,
                doctor: doctor,
                price: price,
                time: time,
                status: 'Ø§Ù†ØªØ¸Ø§Ø±',
                timestamp: serverTimestamp(),
                dateCreated: new Date().toLocaleDateString('ar-EG', { day: '2-digit', month: '2-digit', year: 'numeric' })
            };
            
            try {
                // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Firestore
                await addDoc(collection(db, "patients"), patientData);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                showNotification("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", "success");
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
                toggleModal('addModal', false);
                clearFormFields();
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
                showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
            }
        }
        
        // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#27ae60' : '#e74c3c'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        function clearFormFields() {
            document.getElementById('pName').value = '';
            document.getElementById('pAge').value = '';
            document.getElementById('pPhone').value = '';
            document.getElementById('pPrice').value = '200';
            document.getElementById('pTime').value = '';
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function updateUI() {
            const tbody = document.getElementById('todayTable');
            
            if (patients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <h3 style="color: #7f8c8d; margin: 10px 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                            <p style="color: #95a5a6;">Ø¥Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯" Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            patients.forEach((p, i) => {
                const statusClass = p.status === 'ÙƒØ´Ù' ? 'status-checked' : 
                                  p.status === 'Ù…Ù†ØªÙ‡ÙŠ' ? 'status-finished' : 'status-waiting';
                
                html += `<tr>
                    <td>${i + 1}</td>
                    <td><b>${p.name}</b></td>
                    <td>${p.age || '-'}</td>
                    <td dir="ltr">${p.phone}</td>
                    <td>${p.doctor}</td>
                    <td>
                        <select class="status-select ${statusClass}" onchange="updateStatusInFirebase('${p.id}', this.value)">
                            <option value="Ø§Ù†ØªØ¸Ø§Ø±" ${p.status === 'Ø§Ù†ØªØ¸Ø§Ø±' ? 'selected' : ''}>â³ Ø§Ù†ØªØ¸Ø§Ø±</option>
                            <option value="ÙƒØ´Ù" ${p.status === 'ÙƒØ´Ù' ? 'selected' : ''}>âœ… ÙƒØ´Ù</option>
                            <option value="Ù…Ù†ØªÙ‡ÙŠ" ${p.status === 'Ù…Ù†ØªÙ‡ÙŠ' ? 'selected' : ''}>ğŸ Ù…Ù†ØªÙ‡ÙŠ</option>
                        </select>
                    </td>
                    <td>${p.time || '-'}</td>
                    <td><b>${p.price || 0}</b> Ø¬.Ù…</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; background: #fdedec; color: #e74c3c; border: none;" 
                                onclick="deleteFromFirebase('${p.id}', '${p.name}')">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
            updateStats();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Firebase
        async function updateStatusInFirebase(id, newStatus) {
            try {
                const patientRef = doc(db, "patients", id);
                await updateDoc(patientRef, {
                    status: newStatus,
                    lastUpdated: serverTimestamp()
                });
                
                showNotification("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶", "success");
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©:", error);
                showNotification("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©", "error");
            }
        }
        
        // Ø­Ø°Ù Ù…Ø±ÙŠØ¶ Ù…Ù† Firebase
        async function deleteFromFirebase(id, name) {
            if (confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶: ${name}ØŸ`)) {
                try {
                    await deleteDoc(doc(db, "patients", id));
                    showNotification("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­", "success");
                } catch (error) {
                    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", error);
                    showNotification("âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶", "error");
                }
            }
        }
        
        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„
        async function globalSearch(val) {
            const resDiv = document.getElementById('searchResults');
            
            if (!val.trim()) {
                resDiv.style.display = 'none';
                return;
            }
            
            try {
                const patientsCollection = collection(db, "patients");
                const snapshot = await getDocs(patientsCollection);
                let results = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const name = data.name || '';
                    const phone = data.phone || '';
                    
                    if (name.includes(val) || phone.includes(val)) {
                        results.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                if (results.length > 0) {
                    resDiv.innerHTML = results.slice(0, 8).map(r => `
                        <div class="search-item" onclick="reBookFromSearch('${r.name}', '${r.age}', '${r.phone}', '${r.doctor}')">
                            <div>
                                <strong>${r.name}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 3px;">
                                    ${r.phone} â€¢ ${r.doctor}
                                </div>
                            </div>
                            <span style="font-size:11px; color:var(--primary-green);">
                                Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø¬Ø²
                            </span>
                        </div>
                    `).join('');
                    resDiv.style.display = 'block';
                } else {
                    resDiv.innerHTML = `<div class="search-item" style="color: #999; cursor: default;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«</div>`;
                    resDiv.style.display = 'block';
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:", error);
                resDiv.style.display = 'none';
            }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø¬Ø² Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
        function reBookFromSearch(name, age, phone, doctor) {
            toggleModal('addModal', true);
            document.getElementById('pName').value = name;
            document.getElementById('pAge').value = age;
            document.getElementById('pPhone').value = phone;
            document.getElementById('pDoc').value = doctor;
            document.getElementById('searchResults').style.display = 'none';
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateStats() {
            currentStats = {
                totalPatients: patients.length,
                totalRevenue: 0,
                byDoctor: {}
            };
            
            patients.forEach(p => {
                const price = parseFloat(p.price) || 0;
                currentStats.totalRevenue += price;
                
                if (!currentStats.byDoctor[p.doctor]) {
                    currentStats.byDoctor[p.doctor] = { count: 0, revenue: 0 };
                }
                currentStats.byDoctor[p.doctor].count++;
                currentStats.byDoctor[p.doctor].revenue += price;
            });
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function showStats() {
            let html = `
                <h3 style="text-align:center; color:var(--primary-green); margin-bottom:20px;">
                    <i class="fas fa-chart-pie"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
                </h3>
                
                <div style="background: linear-gradient(135deg, var(--baby-green), #e8f6f3); 
                            padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 14px; color: var(--dark-green); margin-bottom: 5px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
                    <div style="font-size: 32px; font-weight: bold; color: var(--text);">${currentStats.totalPatients}</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #e8f6f3, var(--baby-green)); 
                            padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 14px; color: var(--dark-green); margin-bottom: 5px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                    <div style="font-size: 32px; font-weight: bold; color: var(--text);">${currentStats.totalRevenue.toFixed(2)} Ø¬.Ù…</div>
                </div>
                
                <h4 style="color: var(--dark-green); border-bottom: 2px solid var(--baby-green); 
                           padding-bottom: 8px; margin-top: 25px;">
                    <i class="fas fa-user-md"></i> Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙƒØªÙˆØ±
                </h4>
            `;
            
            Object.entries(currentStats.byDoctor).forEach(([doctor, data]) => {
                html += `
                    <div class="stat-row">
                        <span>${doctor}</span>
                        <span style="font-weight: bold;">
                            ${data.count} Ø­Ø§Ù„Ø© | ${data.revenue.toFixed(2)} Ø¬.Ù…
                        </span>
                    </div>
                `;
            });
            
            html += `
                <button class="btn btn-add" style="width:100%; margin-top:25px; padding:14px; justify-content:center;" 
                        onclick="toggleModal('infoModal', false)">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            `;
            
            document.getElementById('infoContent').innerHTML = html;
            toggleModal('infoModal', true);
        }
        
        // Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
        async function showHistory() {
            try {
                const patientsCollection = collection(db, "patients");
                const snapshot = await getDocs(query(patientsCollection, orderBy("timestamp", "desc")));
                
                let allPatients = [];
                let dates = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.dateCreated || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®';
                    
                    if (!dates[date]) {
                        dates[date] = { count: 0, revenue: 0, patients: [] };
                    }
                    
                    dates[date].count++;
                    dates[date].revenue += parseFloat(data.price) || 0;
                    dates[date].patients.push(data);
                });
                
                let html = `
                    <h3 style="text-align:center; color:var(--primary-green); margin-bottom:20px;">
                        <i class="fas fa-archive"></i> Ø³Ø¬Ù„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                    </h3>
                `;
                
                Object.entries(dates).forEach(([date, data]) => {
                    html += `
                        <div style="background: var(--light-gray); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: var(--dark-green);">
                                    <i class="fas fa-calendar-alt"></i> ${date}
                                </strong>
                                <span style="font-weight: bold;">
                                    ${data.count} Ø­Ø§Ù„Ø© | ${data.revenue.toFixed(2)} Ø¬.Ù…
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    <button class="btn btn-add" style="width:100%; margin-top:20px; padding:14px; justify-content:center;" 
                            onclick="toggleModal('infoModal', false)">
                        <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                    </button>
                `;
                
                document.getElementById('infoContent').innerHTML = html;
                toggleModal('infoModal', true);
                
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ:", error);
                showNotification("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ", "error");
            }
        }
        
        // ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…
        function exportToday() {
            if (patients.length === 0) {
                showNotification("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±", "error");
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Ø§Ù„Ø±Ù‚Ù…,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø¹Ù…Ø±,Ø§Ù„Ù‡Ø§ØªÙ,Ø§Ù„Ø¯ÙƒØªÙˆØ±,Ø§Ù„Ø­Ø§Ù„Ø©,Ø§Ù„Ù…ÙˆØ¹Ø¯,Ø§Ù„Ø³Ø¹Ø±\n";
            
            patients.forEach((p, i) => {
                const row = [
                    i + 1,
                    p.name,
                    p.age || '',
                    p.phone,
                    p.doctor,
                    p.status,
                    p.time || '',
                    p.price || 0
                ].map(field => `"${field}"`).join(',');
                
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Ø¹ÙŠØ§Ø¯Ø§Øª_ÙÙ‚ÙŠÙ‡Ø§_${new Date().toLocaleDateString('ar-EG')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­", "success");
        }
        
        // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function toggleModal(id, show) {
            const modal = document.getElementById(id);
            modal.style.display = show ? 'flex' : 'none';
            
            if (show && id === 'addModal') {
                document.getElementById('pName').focus();
                
                if (!document.getElementById('pTime').value) {
                    const now = new Date();
                    const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                                     now.getMinutes().toString().padStart(2, '0');
                    document.getElementById('pTime').value = timeString;
                }
            }
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                toggleModal('addModal', false);
                toggleModal('infoModal', false);
            }
        });
        
        // Ø¥ØºÙ„Ø§Ù‚ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· CSS Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
