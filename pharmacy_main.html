<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙŠØ¯Ù„ÙŠØ© Ø¹ÙŠØ§Ø¯Ø§Øª ÙÙ‚ÙŠÙ‡Ø§ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ... (Ù†ÙØ³ Ø§Ù„Ù€ CSS Ø§Ù„Ù„ÙŠ Ø¥Ù†Øª Ø¨Ø¹ØªÙ‡) ... */
        :root { --main-teal: #4db6ac; --light-teal: #e0f2f1; --bg-gray: #f4f7f6; --white: #ffffff; --dark-teal: #00897b; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-gray); overflow: hidden; }
        .top-bar { background-color: var(--main-teal); padding: 10px 20px; display: flex; align-items: center; color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .menu-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; margin-left: 15px; }
        .search-container { flex: 1; position: relative; margin-right: 20px; }
        .search-container input { width: 100%; padding: 8px 35px 8px 15px; border-radius: 20px; border: none; outline: none; }
        .side-drawer { position: fixed; top: 0; right: -300px; width: 300px; height: 100%; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.2); transition: 0.3s ease; z-index: 1000; display: flex; flex-direction: column; }
        .side-drawer.open { right: 0; }
        .drawer-header { padding: 20px; background: var(--main-teal); color: white; font-weight: bold; display: flex; justify-content: space-between; }
        .doctor-list { padding: 10px; overflow-y: auto; }
        .doc-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; border-radius: 8px; margin-bottom: 5px; }
        .doc-item:hover { background: var(--light-teal); }
        .badge-count { background: var(--main-teal); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 999; }
        .overlay.show { display: block; }
        .content { padding: 20px; height: calc(100vh - 60px); overflow-y: auto; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-right: 5px solid var(--main-teal); cursor: pointer; transition: 0.3s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .patient-name { font-weight: bold; color: var(--dark-teal); display: block; margin-bottom: 10px; }
        .status-bar { font-size: 0.8rem; color: #888; display: flex; justify-content: space-between; margin-top: 10px; }
        
        /* Ù…ÙŠØ²Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø¬Ø§Ù„ */
        .new-badge { background: #ff5252; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% {opacity: 1} 50% {opacity: 0.5} 100% {opacity: 1} }
    </style>
</head>
<body>

    <div class="top-bar">
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <div class="search-container">
            <input type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶..." id="searchInput">
        </div>
        <div id="currentFilter" style="font-size: 0.9rem;">ÙƒÙ„ Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø©</div>
    </div>

    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>
    <div class="side-drawer" id="sideDrawer">
        <div class="drawer-header">
            <span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</span>
            <button onclick="toggleMenu()" style="background:none; border:none; color:white; cursor:pointer;">âœ•</button>
        </div>
        <div class="doctor-list" id="doctorMenu">
            <div class="doc-item" onclick="filterByDoctor('all', 'ÙƒÙ„ Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø©')"><strong>Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</strong></div>
            </div>
    </div>

    <div class="content">
        <div class="cards-grid" id="cardsGrid">
            </div>
    </div>

    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBy8xPvxQuC6bVLerLpSjzPmvBWyAhuYKo",
            authDomain: "mogama-49e7f.firebaseapp.com",
            projectId: "mogama-49e7f",
            storageBucket: "mogama-49e7f.firebasestorage.app",
            messagingSenderId: "575066177594",
            appId: "1:575066177594:web:82137834158b4c353db503"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentDocFilter = 'all';

        // 1. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±ÙˆØ´ØªØ§Øª "Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©" Ø§Ù„Ù„ÙŠ Ù„Ø³Ù‡ Ù…Ø§ØªØµØ±ÙØªØ´
        const q = query(collection(db, "patients"), where("status", "==", "Ù…Ù†ØªÙ‡ÙŠ"));
        
        onSnapshot(q, (snapshot) => {
            const grid = document.getElementById('cardsGrid');
            const docMenu = document.getElementById('doctorMenu');
            grid.innerHTML = "";
            
            let docCounts = {};

            if (!snapshot.empty && snapshot.docChanges().some(change => change.type === "added")) {
                document.getElementById('alertSound').play(); // ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ
            }

            snapshot.forEach((docSnap) => {
                const p = docSnap.data();
                const pId = docSnap.id;
                
                // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø±ÙˆØ´ØªØ§Øª ÙƒÙ„ Ø¯ÙƒØªÙˆØ± Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
                docCounts[p.doctor] = (docCounts[p.doctor] || 0) + 1;

                if (currentDocFilter !== 'all' && p.doctor !== currentDocFilter) return;

                // Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©: Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                const now = new Date();
                const visitTime = p.timestamp ? new Date(p.timestamp.seconds * 1000) : now;
                const diffMins = Math.floor((now - visitTime) / 60000);
                const isNew = diffMins < 5;

                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => window.location.href = `prescription_details.html?id=${pId}`;
                card.innerHTML = `
                    <span class="patient-name">
                        ${isNew ? '<span class="new-badge">Ø¬Ø¯ÙŠØ¯</span>' : ''}
                        ${p.name}
                    </span>
                    <div style="font-size:0.8rem; color:var(--dark-teal)">ğŸ©º Ø¯. ${p.doctor}</div>
                    <div style="font-size:0.9rem; margin-top:5px; color:#666">
                        ${p.prescription ? p.prescription.length + " Ø£ØµÙ†Ø§Ù Ø¯ÙˆØ§Ø¡" : "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù..."}
                    </div>
                    <div class="status-bar">
                        <span style="${diffMins > 15 ? 'color:#ff9800; font-weight:bold' : ''}">
                            <i class="fas fa-clock"></i> Ù…Ù†ØªØ¸Ø± Ù…Ù†Ø° ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©
                        </span>
                        <span>ğŸ‘ï¸ ${p.views || 0}</span>
                    </div>
                `;
                grid.appendChild(card);
            });

            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø© ÙÙŠ Ø§Ù„Ø¬Ù†Ø¨
            updateDoctorList(docCounts);
        });

        function updateDoctorList(counts) {
            const menu = document.getElementById('doctorMenu');
            menu.innerHTML = `<div class="doc-item" onclick="filterByDoctor('all', 'ÙƒÙ„ Ø§Ù„Ø¯ÙƒØ§ØªØ±Ø©')"><strong>Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</strong></div>`;
            for (const docName in counts) {
                menu.innerHTML += `
                    <div class="doc-item" onclick="filterByDoctor('${docName}', 'Ø¯. ${docName}')">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>Ø¯. ${docName}</strong>
                            <span class="badge-count">${counts[docName]}</span>
                        </div>
                    </div>`;
            }
        }

        window.filterByDoctor = (docId, docName) => {
            currentDocFilter = docId;
            document.getElementById('currentFilter').innerText = docName;
            toggleMenu();
            // Ø§Ù„Ù€ onSnapshot Ù‡ÙŠØ­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        };

        window.toggleMenu = () => {
            document.getElementById('sideDrawer').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('show');
        };

        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
        document.getElementById('searchInput').oninput = (e) => {
            const val = e.target.value.toLowerCase();
            document.querySelectorAll('.card').forEach(card => {
                const name = card.querySelector('.patient-name').innerText.toLowerCase();
                card.style.display = name.includes(val) ? 'block' : 'none';
            });
        };
    </script>
</body>
</html>
