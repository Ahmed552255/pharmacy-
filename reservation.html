<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل المرضى | نظام الاستقبال</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; text-align: right; }
        .form-card { background: white; max-width: 500px; margin: auto; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h2 { color: #45b39d; text-align: center; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn-send { background: #45b39d; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-send:hover { background: #16a085; }
        .status-msg { text-align: center; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="form-card">
    <h2><i class="fas fa-user-plus"></i> تسجيل مريض جديد</h2>
    <hr>
    
    <div class="input-group">
        <label>اسم المريض</label>
        <input type="text" id="pName" placeholder="الاسم ثلاثي">
    </div>

    <div class="input-group">
        <label>عمر المريض</label>
        <input type="number" id="pAge" placeholder="العمر بالسنين">
    </div>

    <div class="input-group">
        <label>رقم الموبايل</label>
        <input type="tel" id="pPhone" placeholder="01xxxxxxxxx">
    </div>

    <div class="input-group">
        <label>اختيار الدكتور</label>
        <select id="pDoctor">
            <option value="">-- اختر الطبيب --</option>
            <option value="زين سعد">د. زين سعد</option>
            <option value="أحمد علي">د. أحمد علي</option>
        </select>
    </div>

    <button class="btn-send" onclick="submitToCloud()">تأكيد الحجز وإرسال</button>
    <div id="msg" class="status-msg"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBy8xPvxQuC6bVLerLpSjzPmvBWyAhuYKo",
        authDomain: "mogama-49e7f.firebaseapp.com",
        projectId: "mogama-49e7f",
        storageBucket: "mogama-49e7f.firebasestorage.app",
        messagingSenderId: "575066177594",
        appId: "1:575066177594:web:82137834158b4c353db503"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // دالة توحيد التاريخ (YYYY-MM-DD) لضمان دقة البحث
    const getTodayDate = () => {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    window.submitToCloud = async () => {
        const name = document.getElementById('pName').value.trim();
        const age = document.getElementById('pAge').value.trim();
        const phone = document.getElementById('pPhone').value.trim();
        const doctor = document.getElementById('pDoctor').value;
        const msgDiv = document.getElementById('msg');

        if (!name || !age || !phone || !doctor) {
            alert("برجاء ملء كافة البيانات");
            return;
        }

        msgDiv.style.color = "blue";
        msgDiv.innerText = "جاري الحجز...";

        try {
            await addDoc(collection(db, "appointments"), {
                patient_name: name,
                patient_age: age,
                patient_phone: phone,
                assigned_doctor: doctor, // اسم الدكتور للبحث عنه
                booking_date: getTodayDate(), // تاريخ اليوم الموحد
                status: "انتظار",
                created_at: serverTimestamp() // للترتيب الزمني
            });

            msgDiv.style.color = "green";
            msgDiv.innerText = "تم الحجز بنجاح وإرساله للدكتور";
            
            // تصفير الفورم
            document.getElementById('pName').value = "";
            document.getElementById('pAge').value = "";
            document.getElementById('pPhone').value = "";
        } catch (e) {
            msgDiv.style.color = "red";
            msgDiv.innerText = "فشل الاتصال: " + e.message;
        }
    };
</script>
</body>
</html>
